<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <style type="text/css">
body {
    padding-top: 1.5rem;
    padding-bottom: 90rem;
}

.header {
    margin-bottom: 2rem;

    padding-right: 0;
    padding-left: 0;
    padding-bottom: 1rem;
    border-bottom: .05rem solid #e5e5e5;
}
    </style>
</head>
<body>
<div class="container">
    <div class="header clearfix">
        <nav>
            <ul class="nav nav-pills float-xs-right">
                <li class="nav-item">
                    <a class="nav-link" href="/u/manage_trail.html">Manage</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/p/about.html">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Contact</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Login <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="jumbotron">
        <h1 class="text-xs-center">Hello, please login!</h1>
        <div class="card card-inverse card-danger text-xs-center hidden-xs-up" id="login-error">
            <div class="card-block">
                <p class="card-text" style="color: white;">
                    <strong>You provided invalid credentials. Please try again.</strong>
                </p>
            </div>
        </div>
        <form id="login-form">
            <div class="form-group row">
                <label for="login-email" class="hidden-xs-down col-sm-2 col-form-label">Email</label>
                <div class="col-xs-12 col-sm-10">
                    <input type="email" class="form-control" id="login-email" placeholder="Email">
                </div>
            </div>
            <div class="form-group row">
                <label for="login-password" class="hidden-xs-down col-sm-2 col-form-label">Password</label>
                <div class="col-xs-12 col-sm-10">
                    <input type="password" class="form-control" id="login-password" placeholder="Password">
                </div>
            </div>
            <div class="form-group row">
                <div class="offset-sm-2 col-xs-10">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="checkbox" id="login-remember-me"> Remember me
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="offset-sm-2 col-xs-10">
                    <a href="#" class="btn btn-primary" id="login-submit">Sign in</a>
                </div>
            </div>
        </form>
    </div>
    <h1 id="sign-up" class="text-xs-center" >Aren't an User yet?</h1>
    <p class="text-xs-center" >Sign up here to get your own tracker for the AT.</p>
    <form id="register-form">
        <div class="form-group row" id="register-email-group">
            <label for="register-email" class="hidden-xs-down col-sm-2 col-form-label">Email</label>
            <div class="col-xs-12 col-sm-10">
                <input type="email" class="form-control" id="register-email" placeholder="Email">
                <div class="form-control-feedback hidden-xs-up" id="register-email-error">Please enter a valid email address.</div>
            </div>
        </div>
        <div class="form-group row" id="register-password-group">
            <label for="register-password" class="hidden-xs-down col-sm-2 col-form-label">Password</label>
            <div class="col-xs-12 col-sm-10">
                <input type="password" class="form-control" id="register-password" placeholder="Password">
                <div class="form-control-feedback hidden-xs-up" id="register-password-error">Please enter a strong password.</div>
            </div>
        </div>
        <div class="form-group row" id="register-repeat-group">
            <label for="register-repeat" class="hidden-xs-down col-sm-2 col-form-label">Repeat</label>
            <div class="col-xs-12 col-sm-10">
                <input type="password" class="form-control" id="register-repeat" placeholder="Repeat">
                <div class="form-control-feedback hidden-xs-up" id="register-repeat-error">Sorry, your passwords don't match.</div>
            </div>
        </div>
        <div class="card card-inverse card-danger text-xs-center hidden-xs-up" id="register-error">
            <div class="card-block">
                <p class="card-text" style="color: white;">
                    <strong>This email is already signed up.</strong>
                </p>
            </div>
        </div>
        <div class="form-group row">
            <div class="offset-sm-2 col-xs-10">
                <a href="#" class="btn btn-secondary" id="register-submit">Sign Up</a>
            </div>
        </div>
    </form>
</div>
<script>
(function() {
    'use strict';

    var loginError = $('#login-error');
    var loginButton = $('#login-submit');
    var loginFrom = $('#login-form');

    loginButton.click(submitCredentials);
    loginFrom.keydown(function(event) {
        if (event.keyCode == 13) {
            return submitCredentials();
        }
     });

    function submitCredentials(event) {
        loginError.addClass('hidden-xs-up');
        $.post(
            '${env.HEROKU_URL}/api/v1/sessions/',
            JSON.stringify({
                email: $('#login-email').val(),
                password: $('#login-password').val()
            }),
            redirect
        ).fail(errorHandler);
        return false;
    }

    function errorHandler(request) {
        loginError.removeClass('hidden-xs-up');
        $('#login-password').focus();
    }

    function redirect(response) {
        localStorage.removeItem('session-token');
        sessionStorage.removeItem('session-token');

        var token = JSON.parse(response).token;
        var rememberMe = $('#login-remember-me').is(':checked');

        if ( rememberMe ) {
            localStorage.setItem('session-token', token);
        } else {
            sessionStorage.setItem('session-token', token);
        }

        var redirect = '${env.HEROKU_URL}/u/manage_trail.html'
        var params = new URLSearchParams(window.location.search);

        if ( params.has('redirect') ) {
            redirect = params.get('redirect');
        }

        window.location.replace(redirect);
    }

    var registerButton = $('#register-submit');
    var registerForm = $('#register-form');

    registerButton.click(submitSignup);
    registerForm.keydown(function(event) {
        if (event.keyCode == 13) {
            return submitSignup();
        }
    });

    var registerPassword = $('#register-password');
    var registerRepeat = $('#register-repeat');

    var registerPasswordGroup = $('#register-password-group');
    var registerPasswordError = $('#register-password-error');
    var registerRepeatGroup = $('#register-repeat-group');
    var registerRepeatError = $('#register-repeat-error');

    registerPassword.change(checkPassword);
    registerRepeat.change(checkPassword);

    function checkPassword() {
        if ( registerPassword.val().length <= 0 ) {
            registerPasswordGroup.addClass('has-danger');
            registerPasswordError.removeClass('hidden-xs-up');
            return false;
        } else {
            registerPasswordGroup.removeClass('has-danger');
            registerPasswordError.addClass('hidden-xs-up');
        }

        return registerRepeat.val().length > 0 && checkRepeat();
    }

    function checkRepeat() {
        if ( registerPassword.val() !== registerRepeat.val() ) {
            registerRepeatGroup.addClass('has-danger');
            registerRepeatError.removeClass('hidden-xs-up');
            return false;
        } else {
            registerRepeatGroup.removeClass('has-danger');
            registerRepeatError.addClass('hidden-xs-up');
            return true;
        }
    }

    var registerEmail = $('#register-email');

    var registerEmailGroup = $('#register-email-group');
    var registerEmailError = $('#register-email-error');

    registerEmail.change(checkEmail);

    function checkEmail() {
        if ( ! /\S+@\S+\.\S+/.test(registerEmail.val()) ) {
            registerEmailGroup.addClass('has-danger');
            registerEmailError.removeClass('hidden-xs-up');
            return false;
        } else {
            registerEmailGroup.removeClass('has-danger');
            registerEmailError.addClass('hidden-xs-up');
            return true;
        }
    }

    function submitSignup() {
        var emailError = $('#register-error');

        if ( checkEmail() && checkRepeat() && checkPassword() ) {
            emailError.addClass('hidden-xs-up');
            $.post(
                '${env.HEROKU_URL}/api/v1/users/',
                JSON.stringify({
                    email: $('#register-email').val(),
                    password: $('#register-password').val()
                })
            )
            .done( function() { console.log('success'); } )
            .fail( function() {
                emailError.removeClass('hidden-xs-up');
            } );
        } else {
            console.log('validation fail');
        }
        return false;
    }

})();

</script>
</body>
</html>