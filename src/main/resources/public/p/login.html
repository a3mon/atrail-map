<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>
    <style type="text/css">
body {
    padding-top: 1.5rem;
    padding-bottom: 90rem;
}

.header {
    margin-bottom: 2rem;

    padding-right: 0;
    padding-left: 0;
    padding-bottom: 1rem;
    border-bottom: .05rem solid #e5e5e5;
}
    </style>
</head>
<body>
<div class="container">
    <div class="header clearfix">
        <nav>
            <ul class="nav nav-pills float-xs-right">
                <li class="nav-item">
                    <a class="nav-link" href="/u/manage_trail.html">Manage</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/p/about.html">About</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Contact</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="#">Login <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="jumbotron">
        <h1 class="text-xs-center">Hello, please login!</h1>
        <div class="card card-inverse card-danger text-xs-center hidden-xs-up" id="login-error">
            <div class="card-block">
                <p class="card-text" style="color: white;">
                    <strong>You provided invalid credentials. Please try again.</strong>
                </p>
            </div>
        </div>
        <form id="login-form">
            <div class="form-group row">
                <label for="login-email" class="col-xs-2 col-form-label">Email</label>
                <div class="col-xs-10">
                    <input type="email" class="form-control" id="login-email" placeholder="Email">
                </div>
            </div>
            <div class="form-group row">
                <label for="login-password" class="col-xs-2 col-form-label">Password</label>
                <div class="col-xs-10">
                    <input type="password" class="form-control" id="login-password" placeholder="Password">
                </div>
            </div>
            <div class="form-group row">
                <div class="offset-sm-2 col-xs-10">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input class="form-check-input" type="checkbox" id="login-remember-me"> Remember me
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="offset-sm-2 col-xs-10">
                    <a href="#" class="btn btn-primary" id="login-submit">Sign in</a>
                </div>
            </div>
        </form>
    </div>
    <h1 id="sign-up" class="text-xs-center" >Aren't an User yet?</h1>
    <p class="text-xs-center" >Sign up here to get your own tracker for the AT.</p>
    <form>
        <div class="form-group row">
            <label for="register-email" class="col-xs-2 col-form-label">Email</label>
            <div class="col-xs-10">
                <input type="email" class="form-control" id="register-email" placeholder="Email">
            </div>
        </div>
        <div class="form-group row">
            <label for="register-password" class="col-xs-2 col-form-label">Password</label>
            <div class="col-xs-10">
                <input type="password" class="form-control" id="register-password" placeholder="Password">
            </div>
        </div>
        <div class="form-group row">
            <label for="register-repeat" class="col-xs-2 col-form-label">Repeat</label>
            <div class="col-xs-10">
                <input type="password" class="form-control" id="register-repeat" placeholder="Password">
            </div>
        </div>
        <div class="form-group row">
            <div class="offset-sm-2 col-xs-10">
                <a href="#" class="btn btn-secondary" id="register-submit">Sign Up</a>
            </div>
        </div>
    </form>
</div>
<script>
(function() {
    'use strict';

    var loginError = $('#login-error');
    var loginButton = $('#login-submit');
    var loginFrom = $('#login-form');

    loginButton.click(submitCredentials);
    loginFrom.keydown(function(event) {
        if (event.keyCode == 13) {
            return submitCredentials();
        }
     });

    function submitCredentials(event) {
        loginError.addClass('hidden-xs-up');
        $.post(
            '${env.HEROKU_URL}/api/v1/sessions/',
            JSON.stringify({
                email: $('#login-email').val(),
                password: $('#login-password').val()
            }),
            redirect
        ).fail(errorHandler);
        return false;
    }

    function errorHandler(request) {
        loginError.removeClass('hidden-xs-up');
        $('#login-password').focus();
    }

    function redirect(response) {
        localStorage.removeItem('session-token');
        sessionStorage.removeItem('session-token');

        var token = JSON.parse(response).token;
        var rememberMe = $('#login-remember-me').is(':checked');

        if ( rememberMe ) {
            localStorage.setItem('session-token', token);
        } else {
            sessionStorage.setItem('session-token', token);
        }

        var redirect = '${env.HEROKU_URL}/u/manage_trail.html'
        var params = new URLSearchParams(window.location.search);

        if ( params.has('redirect') ) {
            redirect = params.get('redirect');
        }

        window.location.replace(redirect);
    }

})();

</script>
</body>
</html>